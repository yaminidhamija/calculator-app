name: Advanced CI/CD - Calculator App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '11'
  APP_NAME: 'calculator-app'

# Concurrency control - cancel in-progress runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: Build Application
  # ============================================
  build:
    name: üî® Build Application
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-name: ${{ steps.artifact.outputs.name }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Generate version
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      # Using our reusable action
      - name: ‚òï Setup Java
        uses: ./.github/actions/setup-java
        with:
          java-version: ${{ env.JAVA_VERSION }}

      - name: üî® Compile
        run: mvn clean compile

      - name: üì¶ Package
        run: |
          mvn package -DskipTests
          # Rename with version
          mv target/simple-calculator-app-1.0-SNAPSHOT.jar target/calculator-app-${{ steps.version.outputs.version }}.jar

      - name: üìã Set artifact name
        id: artifact
        run: |
          NAME="calculator-jar-${{ steps.version.outputs.version }}"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: üì§ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: target/calculator-app-*.jar
          retention-days: 30

      - name: üìÑ Upload test reports directory
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: |
            pom.xml
            README.md
          retention-days: 7

  # ============================================
  # Job 2: Run Tests (parallel with security)
  # ============================================
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java
        uses: ./.github/actions/setup-java
        with:
          java-version: ${{ env.JAVA_VERSION }}

      - name: üß™ Run unit tests
        run: mvn test

      - name: üìä Generate JaCoCo coverage report
        if: always()
        run: |
          echo "üìä JaCoCo Coverage Report Generated"
          if [ -f target/site/jacoco/index.html ]; then
            echo "‚úÖ Coverage report available at target/site/jacoco/index.html"
          fi

      - name: üì§ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 7

  # ============================================
  # Job 3: Security Check (parallel with test)
  # ============================================
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java
        uses: ./.github/actions/setup-java
        with:
          java-version: ${{ env.JAVA_VERSION }}

      - name: üîç Check dependencies
        run: |
          echo "Running security scan..."
          mvn dependency:tree
          echo "‚úÖ Security scan completed"

  # ============================================
  # Job 4: Build Documentation
  # ============================================
  build-docs:
    name: üìö Build Documentation
    runs-on: ubuntu-latest
    needs: [test, security]

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}

      - name: üì• Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-reports/

      - name: üìö Generate documentation site
        run: |
          mkdir -p docs
          
          # Copy JaCoCo coverage report if it exists
          if [ -d test-reports/target/site/jacoco ]; then
            mkdir -p docs/coverage
            cp -r test-reports/target/site/jacoco/* docs/coverage/
            echo "‚úÖ Coverage report copied to docs/coverage/"
          fi
          
          # Create index.html
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Calculator App - Build ${{ needs.build.outputs.version }}</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container {
                      max-width: 900px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 20px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      overflow: hidden;
                  }
                  .header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 40px;
                      text-align: center;
                  }
                  .header h1 { font-size: 2.5em; margin-bottom: 10px; }
                  .header p { font-size: 1.2em; opacity: 0.9; }
                  .content { padding: 40px; }
                  .section {
                      margin-bottom: 30px;
                      padding: 20px;
                      background: #f8f9fa;
                      border-radius: 10px;
                      border-left: 4px solid #667eea;
                  }
                  .section h2 {
                      color: #667eea;
                      margin-bottom: 15px;
                      font-size: 1.5em;
                  }
                  .badge {
                      display: inline-block;
                      padding: 5px 15px;
                      background: #10b981;
                      color: white;
                      border-radius: 20px;
                      font-size: 0.9em;
                      margin: 5px;
                  }
                  .stats {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      margin-top: 20px;
                  }
                  .stat {
                      background: white;
                      padding: 20px;
                      border-radius: 10px;
                      text-align: center;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  .stat-value {
                      font-size: 2em;
                      font-weight: bold;
                      color: #667eea;
                  }
                  .stat-label {
                      color: #6b7280;
                      margin-top: 5px;
                  }
                  .download-btn {
                      display: inline-block;
                      padding: 15px 30px;
                      background: #667eea;
                      color: white;
                      text-decoration: none;
                      border-radius: 10px;
                      font-weight: bold;
                      transition: transform 0.2s;
                  }
                  .download-btn:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
                  }
                  code {
                      background: #1f2937;
                      color: #10b981;
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-family: 'Courier New', monospace;
                  }
                  .endpoint {
                      background: white;
                      padding: 15px;
                      margin: 10px 0;
                      border-radius: 8px;
                      border-left: 3px solid #10b981;
                  }
                  .method {
                      display: inline-block;
                      padding: 3px 10px;
                      background: #10b981;
                      color: white;
                      border-radius: 4px;
                      font-size: 0.85em;
                      font-weight: bold;
                      margin-right: 10px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üßÆ Calculator App</h1>
                      <p>Version ${{ needs.build.outputs.version }}</p>
                      <p>Built with GitHub Actions CI/CD</p>
                  </div>
          
                  <div class="content">
                      <div class="section">
                          <h2>üìä Build Information</h2>
                          <div class="stats">
                              <div class="stat">
                                  <div class="stat-value">${{ needs.build.outputs.version }}</div>
                                  <div class="stat-label">Version</div>
                              </div>
                              <div class="stat">
                                  <div class="stat-value">‚úÖ</div>
                                  <div class="stat-label">Build Status</div>
                              </div>
                              <div class="stat">
                                  <div class="stat-value">Java 11</div>
                                  <div class="stat-label">Runtime</div>
                              </div>
                          </div>
                      </div>
          
                      <div class="section">
                          <h2>üì¶ Download</h2>
                          <p style="margin-bottom: 15px;">Download the executable JAR file:</p>
                          <a href="calculator-app-${{ needs.build.outputs.version }}.jar" class="download-btn">
                              ‚¨áÔ∏è Download calculator-app-${{ needs.build.outputs.version }}.jar
                          </a>
                      </div>
          
                      <div class="section">
                          <h2>üöÄ Quick Start</h2>
                          <p style="margin-bottom: 15px;">Run the application:</p>
                          <code>java -jar calculator-app-${{ needs.build.outputs.version }}.jar</code>
          
                          <p style="margin-top: 20px; margin-bottom: 10px;">The application will output calculations directly:</p>
                          <div class="endpoint">
                              <strong>Sample Output:</strong><br>
                              5 + 3 = 8<br>
                              10 - 4 = 6<br>
                              6 * 7 = 42<br>
                              15 / 3 = 5.0<br>
                              Is 8 even? true
                          </div>
                      </div>
          
                      <div class="section">
                          <h2>‚ú® Features</h2>
                          <span class="badge">‚ûï Addition</span>
                          <span class="badge">‚ûñ Subtraction</span>
                          <span class="badge">‚úñÔ∏è Multiplication</span>
                          <span class="badge">‚ûó Division</span>
                          <span class="badge">üî¢ Even/Odd Check</span>
                          <span class="badge">üß™ Unit Tested</span>
                          <span class="badge">üîí Security Scanned</span>
                      </div>
          
                      <div class="section">
                          <h2>üîß CI/CD Pipeline</h2>
                          <p>This application was built using a professional CI/CD pipeline:</p>
                          <ul style="margin-top: 15px; margin-left: 20px; line-height: 1.8;">
                              <li>‚úÖ Automated builds on every commit</li>
                              <li>‚úÖ Comprehensive unit testing</li>
                              <li>‚úÖ Security vulnerability scanning</li>
                              <li>‚úÖ Artifact management and versioning</li>
                              <li>‚úÖ Automated documentation generation</li>
                              <li>‚úÖ Deployment to GitHub Pages</li>
                          </ul>
                      </div>
          
                      <div class="section">
                          <h2>üìù API Documentation</h2>
                          <p style="margin-bottom: 15px;">Calculator Operations:</p>
          
                          <div class="endpoint">
                              <span class="method">METHOD</span>
                              <strong>add(int a, int b)</strong><br>
                              <small>Returns the sum of two integers</small>
                          </div>
          
                          <div class="endpoint">
                              <span class="method">METHOD</span>
                              <strong>subtract(int a, int b)</strong><br>
                              <small>Returns the difference between two integers</small>
                          </div>
          
                          <div class="endpoint">
                              <span class="method">METHOD</span>
                              <strong>multiply(int a, int b)</strong><br>
                              <small>Returns the product of two integers</small>
                          </div>
          
                          <div class="endpoint">
                              <span class="method">METHOD</span>
                              <strong>divide(int a, int b)</strong><br>
                              <small>Returns the quotient (throws exception if b=0)</small>
                          </div>
          
                          <div class="endpoint">
                              <span class="method">METHOD</span>
                              <strong>isEven(int number)</strong><br>
                              <small>Returns true if number is even, false otherwise</small>
                          </div>
                      </div>
          
                      <div class="section">
                          <h2>üîó Links</h2>
                          <p><strong>Repository:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">View on GitHub</a></p>
                          <p><strong>Build Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow</a></p>
                          <p><strong>Coverage Report:</strong> <a href="coverage/">View JaCoCo Coverage Report</a></p>
                      </div>
                  </div>
              </div>
          </body>
          </html>
          EOF
          
          # Copy JAR to docs directory
          cp calculator-app-${{ needs.build.outputs.version }}.jar docs/
          
          # Copy surefire test reports to docs
          if [ -d test-reports/target/surefire-reports ]; then
            mkdir -p docs/test-reports
            cp -r test-reports/target/surefire-reports/* docs/test-reports/
            echo "‚úÖ Test reports copied to docs/test-reports/"
          fi
          
          echo "‚úÖ Documentation generated"

      - name: üì§ Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-site
          path: docs/
          retention-days: 30

  # ============================================
  # Job 5: Deploy to Staging (GitHub Pages)
  # ============================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, build-docs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

    steps:
      - name: üì• Download documentation
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: ./docs

      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy version ${{ needs.build.outputs.version }}'

      - name: üìä Deployment summary
        run: |
          echo "## üöÄ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Successfully deployed version **${{ needs.build.outputs.version }}** to staging!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Staging (GitHub Pages) |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.build.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | gh-pages |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Access Your Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Your application is live at:" >> $GITHUB_STEP_SUMMARY
          echo "**https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}**" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 6: Deploy to Production (Manual Approval)
  # ============================================
  deploy-production:
    name: üéâ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

    steps:
      - name: üéâ Production deployment
        run: |
          echo "## üéâ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Version **${{ needs.build.outputs.version }}** approved for production!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This deployment was reviewed and approved." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: **Production**" >> $GITHUB_STEP_SUMMARY
          echo "- Version: **${{ needs.build.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Status: **‚úÖ Live**" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 7: Cleanup Old Artifacts
  # ============================================
  cleanup:
    name: üßπ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: üßπ Cleanup old artifacts
        run: |
          echo "Cleanup completed - old artifacts will be automatically removed after retention period"
          echo "‚úÖ Workflow completed successfully!"